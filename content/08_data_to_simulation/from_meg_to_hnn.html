<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HNN Textbook</title>
    <!-- <base href="/website_redesign/"> -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>

	<div id="mySidebar" class="sidebar">
		<div class="navbar-header">
		<a>
			Human Neocortical Neurosolver
		</a>
		<br>
			<svg class="collapse-icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
				<path d="M9 9H4v1h5V9z"/>
				<path fill-rule="evenodd" clip-rule="evenodd" d="M5 3l1-1h7l1 1v7l-1 1h-2v2l-1 1H3l-1-1V6l1-1h2V3zm1 2h4l1 1v4h2V3H6v2zm4 1H3v7h7V6z"/>
			</svg>
		</div>
		<a href="/website_redesign/content/preface.html">Preface</a>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				1. Overview
			</a>
			<div class="submenu">
				<a href="/website_redesign/content/01_overview/challange.html">1.1 Challenge in Connecting EEG MEG to Neural Circuits </a>
				<a href="/website_redesign/content/01_overview/using_hnn.html">1.2 How HNN solve the Challenge by Bridging Scales</a>
				<a href="/website_redesign/content/01_overview/sample_workflow.html">1.3 Overview of the Simulation Workflow</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				2. Background
			</a>
			<div class="submenu">
				<a href="/website_redesign/content/02_background/biophysical_modeling.html">2.1 Challenge in Connecting EEG MEG to Neural Circuits </a>
				<a href="/website_redesign/content/02_background/signal_origins.html">2.2 The Origins of Source Localize MEG/EEG Primary Currents</a>
				<a href="/website_redesign/content/02_background/glossary.html">2.3 Glossary of Terms</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				3. Assumptions and Validation
			</a>
			<div class="submenu">
				<a href="/website_redesign/content/03_assumptions/template_model.html">3.1 Template Model</a>
				<a href="/website_redesign/content/03_assumptions/cortical_column_structure.html">3.2 Cortical Column Structure</a>
				<a href="/website_redesign/content/03_assumptions/primary_electric_currents.html">3.3 Primary Electrical Currents</a>
				<a href="/website_redesign/content/03_assumptions/neurons_morphology_and_physiology.html">3.4 Neurons: Morphology and Physiology</a>
				<a href="/website_redesign/content/03_assumptions/synaptic_connectivity.html">3.5 Synaptic Connectivity</a>
				<a href="/website_redesign/content/03_assumptions/evoked_and_rhythmic_driving_inputs.html">3.6 Evoked and Rhythmic Driving Inputs</a>
				<a href="/website_redesign/content/03_assumptions/tonic_and_noisy_driving_inputs.html">3.7 Tonic and Noisy Driving Inputs</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				4. Using HNN
			</a>
			<div class="submenu">
				<a href="/website_redesign/content/04_using_hnn/installation.html">4.1 Installation</a>
				<a href="/website_redesign/content/04_using_hnn/network_parameters.html">4.2 Network Parameters</a>
				<a href="/website_redesign/content/04_using_hnn/drive_parameters.html">4.3 Drive Parameters</a>
				<a href="/website_redesign/content/04_using_hnn/loading_data.html">4.4 Loading Data</a>
				<a href="/website_redesign/content/04_using_hnn/running_simulations.html">4.5 Running Simulations</a>
				<a href="/website_redesign/content/04_using_hnn/plotting_firing_patterns.html">4.6 Plotting Firing Patterns</a>
				<a href="/website_redesign/content/04_using_hnn/recording_lfp.html">4.7 Recording and Plotting LFP</a>
				<a href="/website_redesign/content/04_using_hnn/animating_simulations.html">4.8 Animating Simulations</a>
				<a href="/website_redesign/content/04_using_hnn/more_visualizations.html">4.9 Additional Visualizations</a>
				<a href="/website_redesign/content/04_using_hnn/parallelizing.html">4.10 Running Parallel Simulations</a>
				<a href="/website_redesign/content/04_using_hnn/optimization.html">4.11 Optimizing Evoked Responses and Rhythms</a>
				<a href="/website_redesign/content/04_using_hnn/batch_simulation.html">4.12 Running Batch Simulations</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				5. Simulating ERPs
			</a>
			<div class="submenu">
				<a href="/website_redesign/content/05_erps/erps_in_gui.html">2.1 GUI Tutorial of ERP Simulation</a>
				<a href="/website_redesign/content/05_erps/hnn_core.html">2.2 API Tutorial of ERP Simulation</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				6. Simulating Alpha/Beta Rhythms
			</a>
			<div class="submenu">
				<a href="/website_redesign/content/06_alpha_beta/gui.html">6.1 GUI Tutorial of Alpha/Beta Rhythms</a>
				<a href="/website_redesign/content/06_alpha_beta/api.html">6.2 API Tutorial of Alpha/Beta Rhythms</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				7. Simulating Gamma Rhythms
			</a>
			<div class="submenu">
				<a href="/website_redesign/content/07_gamma/gamma_in_gui.html">7.1 GUI Tutorial of Gamma Rhythms</a>
				<a href="/website_redesign/content/07_gamma/gamma_in_api.html">7.2 API Tutorial of Gamma Rhythms</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				8. From Data to Simulation
			</a>
			<div class="submenu">
				<a href="/website_redesign/content/08_data_to_simulation/from_meg_to_hnn.html">8.1 From MEG sensor-space data to HNN simulation</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				9. Feature Demos
			</a>
			<div class="submenu">
				<a href="/website_redesign/content/09_feature_demos/plot_firing_pattern.html">9.1 Plot Firing Pattern</a>
				<a href="/website_redesign/content/09_feature_demos/record_and_plot_extracellular_potentials.html">9.2 Record & Plot Extracellular Potentials</a>
				<a href="/website_redesign/content/09_feature_demos/modifying_local_connectivity.html">9.3 Modifying Local Connectivity</a>
				<a href="/website_redesign/content/09_feature_demos/animating_hnn_simulations.html">9.4 Animating HNN Simulations</a>
				<a href="/website_redesign/content/09_feature_demos/batch_simulation.html">9.5 Batch Simulation</a>
				<a href="/website_redesign/content/09_feature_demos/simulate_beta_modulated_erp.html">9.6 Simulate Beta-modulated ERP</a>
				<a href="/website_redesign/content/09_feature_demos/use_mpi_backend_for_parallelization.html">9.7 Use MPI Backend for Parallelization</a>
				<a href="/website_redesign/content/09_feature_demos/optimize_simulated_evoked_response_parameters.html">9.8 Optimize simulated evoked response parameters</a>
				<a href="/website_redesign/content/09_feature_demos/optimize_simulated_rhythmic_response_parameters.html">9.9 Optimize simulated rhythmic response parameters</a>
			</div>
		</div>
	<div style='height: 30px;'></div>
	</div>

<div id="main">
    <div class="topbar">

        <!-- Topbar menu -->
        <div class="menu-container">
            <div class="menu-icons">
                <button class="openbtn" onclick="toggleNav()">
                    ☰
                </button>
                <a href="" class="home-link">
                    <div class="home-icon-container">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24" 
                            height="24"
                            viewBox="0 0 24 24" 
                            class="home-icon">
                            <path
                                d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"
                            />
                        </svg>
                    </div>
                </a>
                <button class="theme-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                        <path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"></path>
                    </svg>
                </button>
                <div class="dropdown">
                    <button 
                        id="dropdownButton" 
                        class="dropdown-button">
                            <img
                                src="/website_redesign/content/assets/icons/fontsize.png"
                                alt="fontsize"
                            />
                    </button>
                    <div class="dropdown-content">
                        <button 
                            class="fontsize-btn" 
                            onclick="decreaseFontSize()">
                            <img
                                src="/website_redesign/content/assets/icons/fontminus.png"
                                alt="fontminus"
                            />
                        </button>
                        <button 
                            class="fontsize-btn" 
                            onclick="increaseFontSize()">
                            <img
                                src="/website_redesign/content/assets/icons/fontplus.png"
                                alt="fontplus"
                            />
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topbar image -->
        <div class="topbar-logo-container">
            <img 
                id="topbar-logo"
                src="https://hnn.brown.edu/wp-content/uploads/hnn-medium.png"
            />
        </div>

        <!-- Right side of topbar -->
        <div class="socials-container">
            <div class="social-icons">
                <a 
                    href="https://github.com/jonescompneurolab/hnn-core" 
                    target="_blank" 
                    aria-label="GitHub">
                    <img 
                        src="/website_redesign/content/assets/icons/github.png"
                        alt="GitHub">
                </a>
                <a 
                    href="https://bsky.app/profile/hnnsolver.bsky.social" 
                    target="_blank"
                    aria-label="BlueSky">
                    <img 
                        src="/website_redesign/content/assets/icons/bluesky.png"
                        alt="BlueSky">
                </a>
                <a 
                    href="https://www.linkedin.com/company/human-neocortical-neurosolver/" 
                    target="_blank"
                    aria-label="LinkedIn">
                    <img 
                        src="/website_redesign/content/assets/icons/linkedin.png"
                        alt="LinkedIn">
                </a>
            </div>
        </div>
    </div>

    <div id="content-wrapper">
    <div id="content">

<!--
# Title: 8.1 From MEG sensor-space data to HNN simulation
# Updated: 2025-02-04
#
# Contributors:
    # Dylan Daniels
-->
<div class='markdown-cell'>
    <h1>8.1: From MEG sensor-space data to HNN simulation</h1>
<p>This example demonstrates how to calculate an inverse solution of the
median nerve evoked response potential (ERP) in S1 from the MNE
somatosensory dataset, and then simulate a biophysical model network
that reproduces the observed dynamics. Note that we do not expound on
how we came up with the sequence of evoked drives used in this example,
rather, we only demonstrate its implementation. For those who want more
background on the HNN model and the process used to articulate the
proximal and distal drives needed to simulate evoked responses, see the
<code>HNN ERP tutorial</code>. The sequence of evoked drives presented
here is not part of a current publication but is motivated by prior
studies [1], [2].</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        # Authors: Mainak Jas <mainakjas@gmail.com>
#          Ryan Thorpe <ryan_thorpe@brown.edu>

# sphinx_gallery_thumbnail_number = 2
    </code>
</div>
<div class='markdown-cell'>
    <p>Note: This specific notebook requires the installation of several
other, non-HNN packages in order to run and plot MNE output properly.
The next cell will install these packages into your Python environment
automatically.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        %pip install -q mne nibabel ipyevents "pyvista[all]" pyvistaqt
    </code>
</div>
<div class='code-cell'>
    <code class='language-python'>
        # Needed for certain plotting to work
import pyvista as pv
from mne.viz import set_3d_backend
set_3d_backend('notebook')
pv.set_jupyter_backend('client')
    </code>
</div>
<div class='markdown-cell'>
    <p>We will import the packages needed for computing the inverse solution
from the MNE somatosensory dataset. <code>MNE</code>, and its dependency
<code>NiBabel</code> should have been installed using the previous
<code>pip</code> command. The somatosensory dataset can be downloaded by
importing <code>somato</code> from <code>mne.datasets</code>.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        import os.path as op
import matplotlib.pyplot as plt

import mne
from mne.datasets import somato
from mne.minimum_norm import apply_inverse, make_inverse_operator
    </code>
</div>
<div class='markdown-cell'>
    <p>Now we set the the path of the <code>somato</code> dataset for
subject <code>&amp;#x27;01&amp;#x27;</code>.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        data_path = somato.data_path()
subject = '01'
task = 'somato'
raw_fname = op.join(data_path, 'sub-{}'.format(subject), 'meg',
                    'sub-{}_task-{}_meg.fif'.format(subject, task))
fwd_fname = op.join(data_path, 'derivatives', 'sub-{}'.format(subject),
                    'sub-{}_task-{}-fwd.fif'.format(subject, task))
subjects_dir = op.join(data_path, 'derivatives', 'freesurfer', 'subjects')
    </code>
</div>
<div class='markdown-cell'>
    <p>Then, we load the raw data and estimate the inverse operator.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        # Read and band-pass filter the raw data
raw = mne.io.read_raw_fif(raw_fname, preload=True)
l_freq, h_freq = 1, 40
raw.filter(l_freq, h_freq)

# Identify stimulus events associated with MEG time series in the dataset
events = mne.find_events(raw, stim_channel='STI 014')

# Define epochs within the time series
event_id, tmin, tmax = 1, -.2, .17
baseline = None
epochs = mne.Epochs(raw, events, event_id, tmin, tmax, baseline=baseline,
                    reject=dict(grad=4000e-13, eog=350e-6), preload=True)

# Compute the inverse operator
fwd = mne.read_forward_solution(fwd_fname)
cov = mne.compute_covariance(epochs)
inv = make_inverse_operator(epochs.info, fwd, cov)
    </code>
</div>
<div class='markdown-cell'>
    <p>There are several methods to do source reconstruction. Some of the
methods such as MNE are distributed source methods whereas dipole
fitting will estimate the location and amplitude of a single current
dipole. At the moment, we do not offer explicit recommendations on which
source reconstruction technique is best for HNN. However, we do want our
users to note that the dipole currents simulated with HNN are assumed to
be normal to the cortical surface. Hence, using the option
<code>pick_ori=&amp;#x27;normal&amp;#x27;</code> is appropriate.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        snr = 3.
lambda2 = 1. / snr ** 2
evoked = epochs.average()
stc = apply_inverse(evoked, inv, lambda2, method='MNE',
                    pick_ori="normal", return_residual=False,
                    verbose=True)
    </code>
</div>
<div class='markdown-cell'>
    <p>To extract the primary response in primary somatosensory cortex (S1),
we create a label for the postcentral gyrus (S1) in source-space</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        hemi = 'rh'
label_tag = 'G_postcentral'
label_s1 = mne.read_labels_from_annot(subject, parc='aparc.a2009s', hemi=hemi,
                                      regexp=label_tag,
                                      subjects_dir=subjects_dir)[0]
    </code>
</div>
<div class='markdown-cell'>
    <p>Visualizing the distributed S1 activation in reference to the
geometric structure of the cortex (i.e., plotted on a structural MRI)
can help us figure out how to orient the dipole. Note that in the HNN
framework, positive and negative deflections of a current dipole source
correspond to upwards (from deep to superficial) and downwards (from
superficial to deep) current flow, respectively. Uncomment the following
code to open an interactive 3D render of the brain and its surface
activation (requires the <code>pyvista</code> python library). You
should get 2 plots, the first showing the post-central gyrus label from
which the dipole time course was extracted and the second showing MNE
activation at 0.040 sec that resemble the following images.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        '''
Brain = mne.viz.get_brain_class()
brain_label = Brain(subject, hemi, 'white', subjects_dir=subjects_dir)
brain_label.add_label(label_s1, color='green', alpha=0.9)
stc_label = stc.in_label(label_s1)
brain = stc_label.plot(subjects_dir=subjects_dir, hemi=hemi, surface='white',
                       view_layout='horizontal', initial_time=0.04,
                       backend='pyvista')
'''
    </code>
</div>
<div class='markdown-cell'>
    <figure>
<img
src="https://user-images.githubusercontent.com/20212206/106524603-cfe75c80-64b0-11eb-9607-3415195c3e7a.png"
alt="mne_label_fig" />
<figcaption aria-hidden="true">mne_label_fig</figcaption>
</figure>

</div>
<div class='markdown-cell'>
    <figure>
<img
src="https://user-images.githubusercontent.com/20212206/106524542-b514e800-64b0-11eb-835e-497454e75eb9.png"
alt="mne_activity_fig" />
<figcaption aria-hidden="true">mne_activity_fig</figcaption>
</figure>

</div>
<div class='markdown-cell'>
    <p>Now we extract the representative time course of dipole activation in
our labeled brain region using
<code>mode=&amp;#x27;pca_flip&amp;#x27;</code> (see
<code>this MNE-python example</code>_ for more details). Note that the
most prominent component of the median nerve response occurs in the
posterior wall of the central sulcus at ~0.040 sec. Since the dipolar
activity here is negative, we orient the extracted waveform so that the
deflection at ~0.040 sec is pointed downwards. Thus, the ~0.040 sec
deflection corresponds to current flow traveling from superficial to
deep layers of cortex.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        flip_data = stc.extract_label_time_course(label_s1, inv['src'],
                                          mode='pca_flip')
dipole_tc = -flip_data[0] * 1e9

plt.figure()
plt.plot(1e3 * stc.times, dipole_tc, 'ro--')
plt.xlabel('Time (ms)')
plt.ylabel('Current Dipole (nAm)')
plt.xlim((0, 170))
plt.axhline(0, c='k', ls=':')
plt.show()
    </code>
</div>
<div class='markdown-cell'>
    <p>Now, let us try to simulate the same with <code>hnn-core</code>. We
read in the network parameters from <code>N20.json</code> and
instantiate the network.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        import hnn_core
from hnn_core import simulate_dipole, jones_2009_model
from hnn_core import average_dipoles, JoblibBackend

hnn_core_root = op.dirname(hnn_core.__file__)
params_fname = op.join(hnn_core_root, 'param', 'N20.json')
net = jones_2009_model(params_fname)
    </code>
</div>
<div class='markdown-cell'>
    <p>To simulate the source of the median nerve evoked response, we add a
sequence of synchronous evoked drives: 1 proximal, 2 distal, and 1 final
proximal drive. In order to understand the physiological implications of
proximal and distal drive as well as the general process used to
articulate a sequence of exogenous drive for simulating evoked
responses, see the <code>HNN ERP tutorial</code>_. Note that setting
<code>n_drive_cells=1</code> and <code>cell_specific=False</code>
creates a drive with synchronous input across cells in the network.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        # Early proximal drive
weights_ampa_p = {'L2_basket': 0.0036, 'L2_pyramidal': 0.0039,
                  'L5_basket': 0.0019, 'L5_pyramidal': 0.0020}
weights_nmda_p = {'L2_basket': 0.0029, 'L2_pyramidal': 0.0005,
                  'L5_basket': 0.0030, 'L5_pyramidal': 0.0019}
synaptic_delays_p = {'L2_basket': 0.1, 'L2_pyramidal': 0.1,
                     'L5_basket': 1.0, 'L5_pyramidal': 1.0}

net.add_evoked_drive(
    'evprox1', mu=21., sigma=4., numspikes=1, location='proximal',
    n_drive_cells=1, cell_specific=False, weights_ampa=weights_ampa_p,
    weights_nmda=weights_nmda_p, synaptic_delays=synaptic_delays_p,
    event_seed=276)

# Late proximal drive
weights_ampa_p = {'L2_basket': 0.003, 'L2_pyramidal': 0.0039,
                  'L5_basket': 0.004, 'L5_pyramidal': 0.0020}
weights_nmda_p = {'L2_basket': 0.001, 'L2_pyramidal': 0.0005,
                  'L5_basket': 0.002, 'L5_pyramidal': 0.0020}
synaptic_delays_p = {'L2_basket': 0.1, 'L2_pyramidal': 0.1,
                     'L5_basket': 1.0, 'L5_pyramidal': 1.0}

net.add_evoked_drive(
    'evprox2', mu=134., sigma=4.5, numspikes=1, location='proximal',
    n_drive_cells=1, cell_specific=False, weights_ampa=weights_ampa_p,
    weights_nmda=weights_nmda_p, synaptic_delays=synaptic_delays_p,
    event_seed=276)

# Early distal drive
weights_ampa_d = {'L2_basket': 0.0043, 'L2_pyramidal': 0.0032,
                  'L5_pyramidal': 0.0009}
weights_nmda_d = {'L2_basket': 0.0029, 'L2_pyramidal': 0.0051,
                  'L5_pyramidal': 0.0010}
synaptic_delays_d = {'L2_basket': 0.1, 'L2_pyramidal': 0.1,
                     'L5_pyramidal': 0.1}

net.add_evoked_drive(
    'evdist1', mu=32., sigma=2.5, numspikes=1, location='distal',
    n_drive_cells=1, cell_specific=False, weights_ampa=weights_ampa_d,
    weights_nmda=weights_nmda_d, synaptic_delays=synaptic_delays_d,
    event_seed=277)

# Late distal drive
weights_ampa_d = {'L2_basket': 0.0041, 'L2_pyramidal': 0.0019,
                  'L5_pyramidal': 0.0018}
weights_nmda_d = {'L2_basket': 0.0032, 'L2_pyramidal': 0.0018,
                  'L5_pyramidal': 0.0017}
synaptic_delays_d = {'L2_basket': 0.1, 'L2_pyramidal': 0.1,
                     'L5_pyramidal': 0.1}

net.add_evoked_drive(
    'evdist2', mu=84., sigma=4.5, numspikes=1, location='distal',
    n_drive_cells=1, cell_specific=False, weights_ampa=weights_ampa_d,
    weights_nmda=weights_nmda_d, synaptic_delays=synaptic_delays_d,
    event_seed=275)
    </code>
</div>
<div class='markdown-cell'>
    <p>Now we run the simulation over 2 trials so that we can plot the
average aggregate dipole. For a better match to the empirical waveform,
set <code>n_trials</code> to be &gt;=25.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        n_trials = 2
# n_trials = 25
with JoblibBackend(n_jobs=2):
    dpls = simulate_dipole(net, tstop=170., n_trials=n_trials)
    </code>
</div>
<div class='markdown-cell'>
    <p>Since the model is a reduced representation of the larger network
contributing to the response, the model response is noisier than it
would be in the net activity from a larger network where these effects
are averaged out, and the dipole amplitude is smaller than the recorded
data. The post-processing steps of smoothing and scaling the simulated
dipole response allow us to more accurately approximate the true signal
responsible for the recorded macroscopic evoked response [1]<em>,
[2]</em>.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        dpl_smooth_win = 20
dpl_scalefctr = 12
for dpl in dpls:
    dpl.smooth(dpl_smooth_win)
    dpl.scale(dpl_scalefctr)
    </code>
</div>
<div class='markdown-cell'>
    <p>Finally, we plot the driving spike histogram, empirical and simulated
median nerve evoked response waveforms, and output spike histogram.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        fig, axes = plt.subplots(3, 1, sharex=True, figsize=(6, 6),
                         constrained_layout=True)
net.cell_response.plot_spikes_hist(ax=axes[0],
                                   spike_types=['evprox', 'evdist'],
                                   show=False)
axes[1].axhline(0, c='k', ls=':', label='_nolegend_')
axes[1].plot(1e3 * stc.times, dipole_tc, 'r--')
average_dipoles(dpls).plot(ax=axes[1], show=False)
axes[1].legend(['MNE label average', 'HNN simulation'])
axes[1].set_ylabel('Current Dipole (nAm)')
net.cell_response.plot_spikes_raster(ax=axes[2])
    </code>
</div><div class='markdown-cell'>
    <h2>References</h2>
<p>[1] Jones, S. R., Pritchett, D. L., Stufflebeam, S. M., Hämäläinen,
M. &amp; Moore, C. I. Neural correlates of tactile detection: a combined
magnetoencephalography and biophysically based computational modeling
study. J. Neurosci. 27, 10751–10764 (2007).</p>
<p>[2] Neymotin SA, Daniels DS, Caldwell B, McDougal RA, Carnevale NT,
Jas M, Moore CI, Hines ML, Hämäläinen M, Jones SR. Human Neocortical
Neurosolver (HNN), a new software tool for interpreting the cellular and
network origin of human MEG/EEG data. eLife 9, e51214 (2020).
https://doi.org/10.7554/eLife.51214</p>

</div>
        <!-- footer area -->
        <!----------------->
        <div class="footer-area">
            <div class="previous-area" data-link="/website_redesign/content/07_gamma/gamma_in_api.html">
                <div class="previous-icon">
                    <svg class="svg-arrow" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path class="arrow-path" d="M15 5L9 12L15 19" />
                    </svg>
                </div>
                <div class="previous-text">
                    <p>Previous</p>
                    <a>7.2 API Tutorial of Gamma Rhythms</a>
                </div>
            </div>
            <div class="next-area" data-link="/website_redesign/content/09_feature_demos/plot_firing_pattern.html">
                <div class="next-text">
                    <p>Next</p>
                    <a>9.1 Plot Firing Pattern</a>
                </div>
                <div class="next-icon">
                    <svg class="svg-arrow" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path class="arrow-path" d="M15 5L9 12L15 19" />
                    </svg>
                </div>
            </div>
        </div> <!-- close footer -->
    </div> <!-- close content -->
    </div> <!-- close content wrapper -->
</div> <!-- close main -->
<script>
    // ----------------------------------------
    // Manage footer
    // ----------------------------------------
    // This function will update the footer links when a page is loaded
    // locally so that naivagation remains functional without a server
    // Note: this solution is specific to MacOS
    document.addEventListener("DOMContentLoaded", function() {
        if (window.location.protocol === "file:") {
            // Get the current local directory path
            const currentDir = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));

            // Process both previous and next links
            document.querySelectorAll('.previous-area, .next-area').forEach(function(area) {
                const link = area.getAttribute('data-link');
                
                if (link && link.startsWith("/")) {
                    // Extract the local root directory
                    const rootPath = currentDir.split("/website_redesign/")[0];
                    // Prepend root path to link
                    const resolvedLink = "file://" + rootPath + link;
                    area.setAttribute("data-link", resolvedLink);
                }
            });
        }
    });
    // Hide the area if data-link is 'None'
    document.querySelectorAll('.previous-area, .next-area').forEach(function(area) {
        if (area.getAttribute('data-link') === 'None') {
            area.style.display = 'none'; 
        }
    });

    // Redirect to the specified link
    document.querySelectorAll('.previous-area, .next-area').forEach(function(area) {
        area.addEventListener('click', function() {
            window.location.href = area.getAttribute('data-link');
        });
    });

    // ----------------------------------------
    // Manage sidebar
    // ----------------------------------------
    let isSidebarOpen = true; // Sidebar is initially open
    let isSidebarFullyOpen = true; // Sidebar is fully open
    const maxWidth = '350px';

    function toggleNav() {
        const sidebar = document.getElementById("mySidebar");
        const main = document.getElementById("main");

        // Toggle sidebar state
        if (isSidebarOpen) {
            sidebar.style.width = "0";
            main.style.marginLeft = "0";
            isSidebarFullyOpen = false;
        } else {
            sidebar.style.width = maxWidth;
            main.style.marginLeft = maxWidth;  // Match margin to new width
        }

        // Toggle the sidebar state
        isSidebarOpen = !isSidebarOpen;

        // Store the sidebar state in localStorage
        localStorage.setItem("sidebarState", isSidebarOpen ? "open" : "closed");
    }

    // Always listen for the transitionend on the sidebar
    const sidebar = document.getElementById("mySidebar");
    sidebar.addEventListener('transitionend', function() {
        if (sidebar.style.width === maxWidth) {
            // Sidebar has fully opened
            isSidebarFullyOpen = true;
        } else {
            // Sidebar is not fully open
            isSidebarFullyOpen = false;
        }
    });

    // Open the sidebar on page load
    // -----------------------------
    window.onload = function() {
        const sidebar = document.getElementById("mySidebar");
        const main = document.getElementById("main");

        // Retrieve stored state
        const savedState = localStorage.getItem("sidebarState");

        // Determine initial state
        if (savedState === "closed") {
            sidebar.style.width = "0";
            main.style.marginLeft = "0";
            isSidebarOpen = false;
            isSidebarFullyOpen = false;
        } else {
            sidebar.style.width = maxWidth;
            main.style.marginLeft = maxWidth;
            isSidebarOpen = true;
            isSidebarFullyOpen = true;
        }

        // Disable transition for the initial state
        sidebar.style.transition = "none";
        main.style.transition = "none";

        // Re-enable transition for subsequent toggles
        setTimeout(() => {
            sidebar.style.transition = "width 0.5s";
            main.style.transition = "margin-left 0.5s";
        }, 10);
    }

    function toggleSubmenu(event) {
        const header = event.target.closest('#sidebar-header'); // Get the clicked header
        const submenu = header.nextElementSibling; // Get the submenu
        const toggleIcon = header.querySelector('.toggle-icon'); // Get the icon

        if (submenu && submenu.classList.contains('submenu')) {
            submenu.classList.toggle('open'); // Toggle the 'open' class to control visibility
            toggleIcon.textContent = submenu.classList.contains('open') ? '-' : '+'; // Update icon
        }
    }

    // Resolve sidebar links for local development
    // -------------------------------------------
    // This function will update the sidebar links when a page is loaded
    // locally so that sidebar naivagation remains functional without a server
    // Note: this solution is specific to MacOS
    document.addEventListener("DOMContentLoaded", function() {
        if (window.location.protocol === "file:") {
            // get the current local directory path
            const currentDir = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));

            // get 'absolute' links with root of 'website_redesign'
            const links = document.querySelectorAll("#mySidebar a");
            links.forEach(link => {
                const href = link.getAttribute("href");

                if (href && href.startsWith("/")) {
                    // extract the local root directory
                    const rootPath = currentDir.split("/website_redesign/")[0];
                    // prepend root path to link
                    const resolvedHref = "file://" + rootPath + href;
                    link.setAttribute("href", resolvedHref);
                }
            });

            // Update image sources for icons
            const images = document.querySelectorAll(".social-icons img, .menu-icons img");
            images.forEach(img => {
                const src = img.getAttribute("src");

                if (src && src.startsWith("/")) {
                    // extract the local root directory
                    const rootPath = currentDir.split("/website_redesign/")[0];
                    // prepend root path to image source
                    const resolvedSrc = "file://" + rootPath + src;
                    img.setAttribute("src", resolvedSrc);
                }
            });
        }
    });

    // Custom tooltips for the sidebar
    // -------------------------------
    // Flag to track tooltip visibility
    let isTooltipVisible = false;

    // Add text to the 'sidebar-tooltip' attribute for sidebar anchor tags
    document.querySelectorAll('.sidebar a').forEach(anchor => {
        const cleanedText = anchor.textContent.replace(/[+\-]/g, '').trim();
        anchor.setAttribute('sidebar-tooltip', cleanedText);
    });

    // Handle sidebar tooltips
    document.querySelectorAll('.sidebar a').forEach(function(link) {
        link.addEventListener('mouseenter', function(event) {
            const tooltipText = event.target.getAttribute('sidebar-tooltip');
            
            if (!tooltipText || isTooltipVisible || !isSidebarFullyOpen) return; // Only show tooltip if none is visible

            // Check if the text is overflowing
            if (event.target.scrollWidth > event.target.offsetWidth) {
                const delay = 500; // Set the delay time (in ms), adjust as needed

                // Create the tooltip after the delay
                setTimeout(function() {
                    // Remove any existing tooltips
                    const existingTooltip = document.querySelector('.sidebar-tooltip');
                    if (existingTooltip) {
                        existingTooltip.remove();
                    }

                    // Create the tooltip element dynamically
                    const tooltip = document.createElement('div');
                    tooltip.classList.add('sidebar-tooltip');  // Use the existing class
                    tooltip.innerText = tooltipText;

                    // Append the tooltip to the sidebar container
                    const sidebarContainer = document.querySelector('.sidebar');
                    sidebarContainer.appendChild(tooltip);

                    // Get the position of the link and the sidebar container
                    const rect = event.target.getBoundingClientRect();
                    const sidebarRect = sidebarContainer.getBoundingClientRect();

                    // Position the tooltip relative to the sidebar container
                    tooltip.style.position = 'absolute';
                    tooltip.style.left = `${rect.left - sidebarRect.left + sidebarContainer.scrollLeft + 20}px`;
                    tooltip.style.top = `${rect.bottom - sidebarRect.top + sidebarContainer.scrollTop + 5}px`;

                    // Make sure the tooltip is visible
                    tooltip.style.opacity = '1';

                    // Set the flag to true indicating that the tooltip is visible
                    isTooltipVisible = true;
                }, delay); // Delay the tooltip creation
            }
        });

        link.addEventListener('mouseleave', function(event) {
            // Remove the tooltip when the mouse leaves
            const tooltip = document.querySelector('.sidebar-tooltip');
            if (tooltip) {
                tooltip.remove();
            }

            // Reset the flag to false when the tooltip is removed
            isTooltipVisible = false;
        });
    });

    // Close all open submenus in the sidebar
    // --------------------------------------
    document.addEventListener("DOMContentLoaded", function() {
        // Function to close all open submenus in the navbar
        function closeAllSubmenus() {
            const allSubmenus = document.querySelectorAll('.submenu.open'); // Select all open submenus
            allSubmenus.forEach(submenu => {
                submenu.classList.remove('open'); // Remove 'open' class to collapse
                const toggleIcon = submenu.previousElementSibling.querySelector('.toggle-icon');
                if (toggleIcon) {
                    toggleIcon.textContent = '+'; // Reset icon to '+'
                }
            });
        }

        // Add functionality to collapse button (SVG icon)
        const collapseIcon = document.querySelector('.collapse-icon');
        if (collapseIcon) {
            collapseIcon.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent event propagation to avoid unwanted behavior
                closeAllSubmenus(); // Close all open submenus when the icon is clicked
            });
        }
    });

    // Keep the current page open in the sidebar
    // -----------------------------------------
    document.addEventListener("DOMContentLoaded", function () {
        // Get the full path relative to the 'content' folder
        const currentPage = window.location.pathname.split("/content/")[1].split("?")[0];

        // Find the active link using the full path
        const activeLink = document.querySelector(`#mySidebar a[href$='${currentPage}']`);

        if (activeLink) {
            // Apply the active class
            activeLink.classList.add("active");
             // Find the closest submenu
            const submenu = activeLink.closest('.submenu');

            if (submenu) {
                // Keep the submenu open
                submenu.classList.add('open');
                const toggleIcon = submenu.previousElementSibling.querySelector('.toggle-icon');

                if (toggleIcon) {
                    // Ensure the toggle icon reflects the open state
                    toggleIcon.textContent = '-';
                }
            }
        }
    });

    // ------------------------------
    // Font size buttons and dropdown
    // ------------------------------
    document.addEventListener("DOMContentLoaded", function() {
        const content = document.getElementById("content");

        // Retrieve and apply the saved font size
        const savedFontSize = localStorage.getItem("fontSize");
        if (savedFontSize && content) {
            content.style.fontSize = savedFontSize + "px";
        }
    });

    function increaseFontSize() {
        event.stopPropagation();  // Prevent dropdown from closing
        const content = document.getElementById("content");
        const currentSize = parseFloat(window.getComputedStyle(content).fontSize);
        const newSize = currentSize + 1;

        content.style.fontSize = newSize + "px";

        // save font size to localStorage
        localStorage.setItem("fontSize", newSize);
    }

    function decreaseFontSize() {
        event.stopPropagation();  // Prevent dropdown from closing
        const content = document.getElementById("content");
        const currentSize = parseFloat(window.getComputedStyle(content).fontSize);
        const newSize = currentSize - 1;

        content.style.fontSize = newSize + "px";

        // save font size to localStorage
        localStorage.setItem("fontSize", newSize);
    }

    // Dropdown for font buttons
    function toggleDropdown() {
        const dropdownContent = document.querySelector('.dropdown-content');
        dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
    }

    // Open/close dropdown on click of the button
    document.getElementById('dropdownButton').onclick = function(event) {
        event.stopPropagation();  // Prevent the click from triggering the window.onclick event
        toggleDropdown();
    };

    // Close dropdown if clicking outside
    window.onclick = function(event) {
        const dropdownContent = document.querySelector('.dropdown-content');
        if (!event.target.closest('.dropdown')) {  // Close if click outside the dropdown
            dropdownContent.style.display = 'none';
        }
    };

    // ----------------------------------------
    // Toggle between light and dark themes
    // ----------------------------------------
    // Wait for the DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.querySelector('.theme-toggle');
        const sidebar = document.querySelector('.sidebar');
        const sunSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"></path>
            </svg>
        `;
        const moonSVG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                <path d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6c-96.9 0-175.5-78.8-175.5-176c0-65.8 36-123.1 89.3-153.3c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"></path>
            </svg>
        `;

        // Check the saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.classList.toggle('dark-mode', savedTheme === 'dark');
            themeToggle.innerHTML = savedTheme === 'dark' ? moonSVG : sunSVG;
            sidebar.classList.toggle('dark-mode', savedTheme === 'dark');
        } else {
            // Default to light theme if no saved preference
            themeToggle.innerHTML = sunSVG;
        }

        // Add click event to toggle theme
        themeToggle.addEventListener('click', () => {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            themeToggle.innerHTML = isDarkMode ? moonSVG : sunSVG;
            sidebar.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });
    });

</script>

<!------------------------ #
# Code syntax highlighting #
# ------------------------->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />

<script>
    // Remove the leading whitespace/newlines around code blocks 
    // caused by the html structure used for readability
    document.addEventListener("DOMContentLoaded", function() {
        // Select all code blocks
        const codeBlocks = document.querySelectorAll('.code-cell code.language-python');

        codeBlocks.forEach(function(block) {
            // Apply syntax highlighting to the code block
            // Note: The below line is not needed with this setup
            //  but may be useful in the case that the method
            //  is later changed
            // Prism.highlightElement(block);

            // Get the code with highlighted classes
            const highlightedHTML = block.innerHTML;

            // Remove leading/trailing whitespace/newlines
            block.innerHTML = highlightedHTML.trim();
        });

        // Select all output-code blocks
        const outputBlocks = document.querySelectorAll('.output-cell .output-code');

        outputBlocks.forEach(function(block) {
            // Remove unwanted leading/trailing whitespace or newlines
            block.textContent = block.textContent.trim();
        });
    });

</script>

</body>
</html>